# 6. RDS+Aurora+ElasticCache

## RDS

- Relational Database Service
- SQL(Structured Query Language)을 쿼리 언어로 사용하는 데이터베이스 서비스
- RDS에 DB를 생성할 수 있고, AWS가 DB를 관리한다.
- DB 엔진 유형
    - **Postgres, MySQL, MariaDB, Oracle, Microsoft SQL Server**, Aurora(AWS Proprietary database)

### RDS vs Deploying DB on EC2

- RDS는 관리형 서비스
- 데이터베이스를 포함하여 다양한 서비스를 제공한다.
    - 데이터베이스 프로비저닝, 운영체제 패치 자동화
    - 지속적인 백업 생성(특점 시점으로 복원)
    - 모니터링 대시보드
    - 읽기 전용 복제본 → 읽기 성능 개선
    - 재해 복구를 위해 다중 AZ 설정
    - 유지 관리 기간에 업그레이드
    - 인스턴스 유형을 늘려 수직 확장, 읽기 전용 복제본 늘려 수평 확장
    - 파일 스토리지는 EBS(gp2 or io1)에 구성됨
- 단점 : RDS 인스턴스에 **SSH 액세스가 불가능하다.**

### RDS - Storage Auto Scaling

- RDS 데이터베이스를 만들 때, RDS Auto Scaling이 활성화되어 있으면, RDS가 감지해서 자동으로 스토리지를 확장해준다.
- 애플리케이션이 RDS 데이터베이스에서 읽기와 쓰기 작업을 많이 하면 **임계값에 도달**하게 되고 RDS가 자동으로 스토리지를 Auto Scaling한다.
- 이를 위해서는 최대 스토리지 임곗값을 설정해야 한다. = 스토리지를 확장할 최대치를 정해야 한다.
    - 할당된 공간에 남은 공간이 10% 미만이 되면 스토리지를 자동으로 수정한다.
    - 스토리지 부족 상태가 5분 이상 지속되거나 지난 수정으로부터 6시간 지났을 경우, 스토리지가 자동 확장된다.
- **워크로드를 예측할 수 없는 애플리케이션에 유용**하다.
- 모든 RDS 데이터베이스 엔진에서 지원되는 기능이다.

---

## RDS Read Replicas for read scalability

- 읽기 전용 복제본은 읽기를 스케일링한다.
- 애플리케이션은 데이터베이스 인스턴스에 대해 읽기와 쓰기를 수행한다.
- 읽기 전용 복제본을 최대 다섯 개까지 생성할 수 있다.
- 동일한 가용 영역 또는 리전을 걸쳐서 생성될 수 있다.
- 3가지 옵션
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/115cc977-be93-4d62-a103-f9d2e07b5ee0/Untitled.png)
    
    - 주된 RDS 데이터베이스 인스턴스와 읽기 전용 RDS 데이터베이스 복제본 사이에서 비동기식 복제가 발생한다.
        
        ( 비동기식 : 읽기가 일관적으로 유지된다. )
        
    - 애플리케이션에서 데이터를 복제하기 전에 읽기 전용 복제본을 읽으면 모든 데이터를  얻을 수 있다.
- 읽기 전용 RDS 복제본을 데이터베이스로 승격시킬 수 있다.
    - 데이터베이스로 승격시키려면 그에 대한 권한을 획득하면 된다.
    - 승격하게 되면 복제 매커니즘을 탈피하게 된다.
    - 자체적인 생명 주기를 갖는다.
- 읽기 전용 복제본을 사용하려는 경우, 애플리케이션에 있는 모든 연결을 업데이트해야 한다.
    - RDS 클러스터 상의 읽기 전용 복제본 전체 목록을 활용할 수 있다.

### RDS Read Replicas - Use Case

- 평균적인 로드를 감당하는 생산 데이터베이스가 있다.
- 이때 새로운 애플리케이션이 해당 데이터베이스를 기반으로 보고와 분석을 실시한다.
- 해당 애플리케이션에 데이터베이스를 연결하면 오버로드가 발생하여 애플리케이션 속도가 느려진다.
- 이때 새로운 워크로드에 대한 읽기 전용 복제본을 생성한다.
- 데이터베이스 인스턴스와 읽기 전용 복제본 간 비동기식 복제가 발생한다.
- 보고 애플리케이션을 통해서 해당 복제본을 사용하면 된다.
- **읽기 전용 복제본은 SELECT 명령문만 사용**한다.

### RDS Read Replicas - Network Cost

- 하나의 가용 영역에서 다른 가용 영역으로 데이터가 이동할 때 비용이 발생한다.
- 예외가 있는데, 보통 이러한 예외는 관리형 서비스에서 나타난다.
- RDS 읽기 전용 복제본은 관리형 서비스!
    - 읽기 전용 복제본이 다른 AZ 상에 있지만, 동일한 리전 내에 있을 때는 비용이 발생하지 않는다.
    - 다른 리전에 복제본이 존재하는 경우, 네트워크에 대한 비용이 발생한다.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/3ec21f66-5529-4898-ad60-ab77218d18d0/Untitled.png)

### RDS Multi AZ

- 다중 AZ는 재해 복구에 사용된다.
- 스탠바이 RDS DB 인스턴스에 마스터 DB의 모든 변화를 동기적으로 복제한다.
- 애플리케이션이 쓰기 작업을 수행하면 스탠바이 RDS DB에도 변경사항이 그대로 복제된다.
- 하나의 DNS 이름을 갖는다.
- 그래서 만약 마스터에 문제가 생길 때면, 스탠바이 RDS에 자동으로 페일오버된다.
- 이를 통해 가용성을 높일 수 있다. (다중 AZ)
- 전체 AZ 또는 네트워크가 손실될 때 대비한 장애 조치이다.
- **스탠바이 DB는 스케일링할 수 없다. → 그 누구도 읽거나 쓸 수 없다. (대기상태)**
- 마스터 데이터베이스에 문제가 발생할 경우를 대비한 장애 조치이다.

- 재해 복구를 위해 읽기 전용 복제본을 다중 AZ로 설정할 수 있다.

### RDS - From Single AZ to Multi AZ

- 다운타임이 전혀 없다.
- 단일 AZ → 다중 AZ를 전환할 때 데이터베이스를 중지할 필요가 없다.
- RDS 수정을 클릭 후 다중 AZ 기능을 활성화하기만 하면 된다. 그러면 알아서 스탠바이 RDS가 생성된다.
- 내부적으로 다음과 같은 일이 발생한다.
    - 기본 데이터베이스의 RDS가 자동으로 스냅샷을 생성한다.
    - 해당 스냅샷은 새로운 스탠바이 데이터베이스에 복원된다.
    - 복원이 완료되면 두 데이터베이스 사이에서 동기화가 설정된다.
    - 다중 AZ 설정 상태가 된다.

---

## RDS Custom

- 두 유형의 데이터베이스 타입이 지원한다.
    - Oracle, Microsoft SQL Server
- OS 및 데이터베이스 사용자 지정 기능에 액세스할 수 있다.
- RDS를 통해 AWS에서의 데이터베이스 자동화 설정, 운영, 스케일링의 장점을 가질 수 있다.
- RDS Custom 옵션을 추가하면, 기저 데이터베이스와 운영체제에 액세스가 가능해진다.
    - 내부 설정 구성, 패치 적용, 네이티브 기능이 활성화된다.
    - SSH, SSM 세션 관리자를 사용해서 RDS 뒤에 있는 기저 EC2 인스턴스에 액세스할 수 있다.
- RDS가 수시로 자동화, 유지 관리, 스케일링과 같은 작업을 수행하지 않도록 자동화를 꺼두는 것이 좋다.
- 기저 EC2 인스턴스에 액세스가 가능하므로 문제가 생길 것을 방지해 DB 스냅샷을 만들어 두는 것이 좋다.

### RDS vs RDS Custom

- RDS는 데이터베이스 전체를 관리한다.
- RDS Custom은 Oracle 및 Microsoft SQL Server에서만 사용 가능하다. (기저 운영체제 및 DB의 관리자 액세스가 가능)

---

## Amazon Aurora

- AWS 고유 기술이다. (오픈소스 X)
- Postgres 및 MySQL과 호환된다.
    - Aurora 데이터베이스에 호환 가능한 드라이버가 있는데 Postgres 및 MySQL 데이터베이스에 연결하면 작동함을 의미한다.
- 클라우드에 최적화되어 있다. RDS의 MySQL보다 5배 높은 성능, Postgres보다 3배 높은 성능을 가지고 있다.
- Aurora 스토리지는 자동으로 확장하는데 10GB에서 시작하고, 더 많은 데이터를 넣을수록 자동으로 128TB까지 커진다.
- 읽기 전용 복제본은 최대 15개까지 둘 수 있다. 복제 속도도 훨씬 빠르다.
- Aurora의 장애 조치는 즉각적이다. 클라우드 네이티브이므로 가용성이 높다.
- 비용은 RDS에 비해 20% 정도 비싸지만, 스케일링 측면에서 훨씬 더 효율적이다.

### Aurora HA and Read Scaling

- 3개의 AZ를 걸쳐 무엇인가 기록할 때마다 6개의 사본을 저장한다.
    - 6개 사본 중 4개는 쓰기를 위한 것
    - 6개 사본 중 3개는 읽기를 위한 것
    - 자가 복구 과정이 있다.
    - 단일 볼륨에 의존하지 않고, 수 백개의 볼륨을 사용한다.
    - 데이터가 쓰이면, 각기 다른 볼륨에 기록되며 스트라이프 형식으로 되어 있어 매우 잘 작동한다.
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/031d5817-26b5-4ea1-b07d-61d00710c5db/Untitled.png)
    
- Aurora는 RDS의 다중 AZ와 유사하다.
- 쓰기를 받는 인스턴스는 1개(마스터)이고, 마스터가 작동하지 않으면 평균 30초 이내로 장애 조치가 시작된다.
    - 마스터 외에 읽기를 제공하는 읽기 전용 복제본을 15개까지 둘 수 있다.
    - 마스터가 문제가 생기면 읽기 전용 복제본 중 하나가 마스터로 대체된다.
- 복제본들은 리전 간 복제를 지원한다.

### Aurora DB Cluster

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/ba0c928f-7e77-41e3-a67f-b41220445752/Untitled.png)

 클라이언트가 수많은 인스턴스와 어떻게 접속할까?

- Aurora는 항상 하나의 마스터만 가지고 있다.
    - Aurora는 writer 엔드포인트를 제공한다.
    - DNS 이름으로 writer 엔드포인트는 항상 마스터를 가리킨다.
    - 따라서 장애 조치 후에도 클라이언트는 writer 엔드포인트와 상호작용하게 된다.
- 많은 읽기 전용 복제본을 가지고 있다.
    - 복제본에 대해 15개까지 자동 스케일을 설정할 수 있다.
    - **리더 엔드포인**트가 있다.
    - 연결 **로드밸런싱 역할**을 한다.
    - 클라이언트가 리더 엔드포인트에 연결하면, 복제본 중 하나로 연결된다.

---

## Aurora Replicas - Auto Scaling

- 리더 엔드포인트에 읽기 요청이 매우 빈번하게 일어나는 경우
- Amazon Aurora 데이터베이스의 CPU 사용량이 증가한다.
- 이런 상황에 복제본 자동 스케일링을 설정하면 된다.
