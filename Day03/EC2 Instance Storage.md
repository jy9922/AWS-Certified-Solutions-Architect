# EC2 Instance Storage

## EBS Volume

- Elastic Block Store
- 인스턴스가 실행 중애 연결 가능한 **네트워크 드라이브 (물리적 드라이브X)**
    - 네트워크 드라이브이기 때문에 네트워크 지연이 발생할 수 있다.
    - 탈부착이 쉽다. (failover시 유용)
- EBS 볼륨을 사용하면 인스턴스가 종료된 후에 데이터를 지속할 수 있다.
    - 인스턴스를 재생성하여 EBS 볼륨을 마운트하면 데이터를 다시 받을 수 있다.
- CCP 레벨의 경우, 각각의 EBS 볼륨은 하나의 EC2 인스턴스에만 마운트가 가능하다.
    - 하나의 인스턴스에서 여러 EBS 볼륨 연결 가능하다.
- **EC2 인스턴스 가용영역 = EBS 볼륨 가용영역**
    - 서로 다른 가용영역에 있는 인스턴스와 EBS 볼륨은 연결이 불가능하다.
    - 스냅샷을 이용하면 다른 가용 영역으로 볼륨을 옮길 수 있다.
- 원하는 양의 GB, IOPS 등 볼륨 성능을 미리 지정해야 한다.
    - 용량과 성능에 따라 비용이 청구된다.
    - 더 좋은 성능 또는 큰 사이즈를 원하면 추후 늘릴 수 있다.
- 프리티어 : 매달 30GB의 EBS 스토리지를 제공해주고 있다.
- EBS 볼륨을 설정할 때 종료 시 삭제 옵션이 있다.
    - EC2 인스턴스 종료시 EBS 볼륨 행동을 제어할 수 있다.
    - 체크되어 있으면, 인스턴스 종료와 함께 EBS 함께 삭제된다. (root 볼륨은 디폴트 활성화되어 있음)
    - 체크되어 있지 않다면, EBS는 삭제되지 않는다. (다른 EBS 볼륨은 비활성 디폴트)

---

## EBS Snapshot

- **EBS 볼륨의 특정 시점에 대한 백업**이다.
- EC2 인스턴스에서 EBS 볼륨을 분리할 필요는 없지만 권장 사항이다.
- EBS 스냅샷을 다른 가용 영역이나 다른 리전에 복사할 수 있다.

### EBS Snapshot Features

- **EBS Snapshot Archive**
    - 최대 75% 저렴한 아카이브 티어
    - 스냅샷을 옮길 수 있는 기능이다.
    - 복원하는데 24시간에서 최대 72시간 소요된다.
- **Recycle Bin for EBS Snapshot**
    - 스냅샷을 삭제하는 경우 영구 삭제 대신 휴지통에 넣는 것이다.
    - 따라서 휴지통에서 복원 가능하다.
    - 휴지통 보관 기간은 1일부터 최대 1년 사이로 설정할 수 있다.
- **Fast Snapshot Restore (FSR)**
    - 스냅샷을 완전 초기화해 첫 사용에서의 지연시간을 없애는 기능이다.
    - 스냅샷이 아주 크고 EBS 볼륨 또는 EC2 인스턴스를 빠르게 초기화할 때 매우 유용하다.
    - 비용이 많이 든다.

---

## AMI

- Amazon Machine Image
- EC2 인스턴스를 통해 만든 이미지
    - 원하는 소프트웨어 또는 설정 파일을 추가하거나 별도의 운영 체제 모니터링 툴 등 설치할 수 있다.
    - AMI를 따로 구성하면, 부팅 및 설정에 드는 시간을 줄일 수 있다.
    - EC2 인스턴스에 설치하고자 하는 모든 소프트웨어를 AMI가 미리 패키징하기 때문이다.
- **AMI는 특정 AWS 리전에만 국한되며, 각 AWS 리전에는 고유한 AMI가 있다. (다른 리전에서 AMI를 사용해 EC2 인스턴스를 실행하는 것은 불가능하다)**
- **만약 다른 리전에서 AMI를 사용하려면 다른 리전으로 AMI를 복사헤 인스턴스를 생성할 수 있다.**
- EC2 인스턴스를 여러 종류의 AMI를 통해 생성할 수 있다.
    - AWS에서 제공하는 Public AMI
    - 자체적으로 커스텀한 AMI
    - AWS 마켓플레이스 AMI

### AMI Process

- EC2 인스턴스를 원하는 대로 시작한다.
- 인스턴스를 중지해 데이터 무결성을 확보한다.
- 이 인스턴스를 바탕으로 AMI를 구축한다.
    
    → 이 과정에서 EBS 스냅샷이 생성된다.
    
- 다른 인스턴스에서 생성한 AMI를 실행한다.

---

## EC2 Instance Store

- EBS 볼륨은 네트워크 드라이브이기에 제한이 있을 수 있다.
- **더 높은 성능**을 원한다면, **EC 인스턴스에 직접 연결된 하드웨어 디스크인 EC2 Instance Store를 사용**하면 된다.
- 물리적으로 연결된 디스크 공간을 갖는다.
- **I/O 성능 향상을 위해 활용**된다.
- EC2 인스턴스가 중지 또는 종료되면 EC2 Instance Store 스토리지 또한 손실된다.
    - 임시 스토리지로 불리는 이유 중 하나이다.
    - 장기적인 데이터를 보관하기는 힘들다. → 장기적인 스토리지는 EBS가 적합하다.
- 버퍼, 캐시, 스크레치 데이터 또는 임시 콘텐츠 등에 사용하기 좋다.
- EC2 인스턴스의 기본 서버에 장애 발생시, 해당 EC2에 연결된 하드웨어 또한 장애가 발생하여 데이터 손실 위험이 있다.
- 따라서, EC2 Instance Store를 사용할 때는 백업하거나 복제해야 한다.
- EC2 인스턴스에서 데이터베이스를 인스턴스 스토어를 사용하여 실행 가능하지만, EC2 인스턴스가 중지 시 데이터가 손실이라는 문제가 있습니다 (문제 없이 다시 시작할 수 있음).
    - 한 가지 솔루션은 인스턴스 스토어가 있는 다른 EC2 인스턴스에서 복제 메커니즘을 설정하여 대기 복사본을 가질 수 있다는 것입니다.
    - 또 다른 솔루션은 데이터에 대한 백업 메커니즘을 설정하는 것입니다.

---

### EBS Volume type

6개의 타입으로 이루어져 있다.

- gp2/gp3 (SSD) : 다양한 워크로드에 대한 가격과 성능의 절충안
- io1/io2 (SSD) : 최고 성능을 가진 SSD 볼륨, 대용량 워크로드에서 사용
- st1 (HDD) : 저비용 HDD, 잦은 접근과 처리량이 많은 워크로드에서 사용
- sc1 (HDD) : 가장 비용이 적게 드는 HDD 볼륨, 접근 빈도가 낮은 워크로드에서 사용
- EBS 볼륨은 크기, 처리량, IOPS(초당 I/O 작업 수)로 정의된다.
- gp2/gp3, io1/io2만이 부팅 볼륨으로 사용될 수 있다.

### 범용 SSD

- gp2/gp3가 있다.
- 짧은 지연 시간, 비용 효과적인 스토리지이다.
- 1Gib ~ 16TB

### gp2

- 짧은 지연 시간, 효율적인 비용의 스토리지이다.
- 1GB ~ 16TB

### gp3

- 최신 세대의 볼륨
- 기본 성능 3,000 IOPS, 초당 125MB 처리
- 오래된 버전
- 최대 3,000 IOPS,
- 볼륨과 IOPS가 연결되어 있어, GB가 증가하면 IOPS 또한 증가한다.
- 볼륨과 IOPS가 연결되어 있지 않다. 따라서 IOS와 처리량을 독자적으로 설정할 수 있다.

### Provisioned IOPS SSD

- IOPS 성능을 유지할 필요가 있는 비즈니스나 애플리케이션에서 사용
- 16,000 IOPS 이상을 요구하는 애플리케이션에 적합하다.
- 데이터베이스 워크로드에 적합 (스토리지 성능과 일관성에 아주 민감하다.)
- io1/io2가 있다.
- 4Gib - 16TiB
    - Nitro EC2 인스턴스는 최대 64,000 IOPS까지 가능하다.
    - 아닌 경우는 최대 32,000 IOPS까지 지원된다.
    - 프로비저닝된 IOPS를 스토리지 크기와 독자적으로 증가시킬 수 있다.
    - io2는 io1과 동일한 비용으로 내구성과 기가 당 IOPS 수가 더 높다. (io2 사용하는게 더 유리하다.)
- 고성능 유형의 볼륨이다.
- 지연 시간이 밀리초 미만이다.
- IOPS 대 GB 비율이 1,000:1일 때, 최대 256,000 IOPS까지 늘어난다.

부팅 볼륨으로 사용할 수 있는 EBS 볼륨 유형 : gp2, gp3, io1, io2

### Hard Disk Drives (HDD)

- 최대 16TB까지 확장 가능하다.
- st1 (처리량 최적화 HDD)
    - 빅데이터, 데이터 웨어하우스, 로그 처리에 적합
    - 최대 처리량은 초당 500MB
    - 최대 IOPS는 500
- sc1 (Cold HDD)
    - 알카이브 데이터
    - 접근 빈도가 낮은 데이터에 적합
    - 최저 비용으로 데이터 저장에 사용한다.
    - 최대 처리량은 초당 250MB, 최대 IOPS 250

---

## EBS Multi-Attach

- 하나의 EBS 볼륨을 같은 가용 영역에 있는 여러 EC2 인스턴스에 연결할 수 있게 해준다.
- EBS 볼륨 중 **io1과 io2 제품군에서만 사용**할 수 있다.
- 각 인스턴스는 고성능 볼륨에 대한 읽기 및 쓰기 권한을 전부 갖는다. (동시에 읽고, 쓰기 가능)
- Use Case
    - 애플리케이션 가용성을 높이기 위한, 클러스터링된 Linux 애플리케이션에서 사용
    - 애플리케이션을 동시 쓰기 작업을 관리해야할 때 사용
- 다중 EBS는 같은 영역 내에서만 사용 가능하다.
- **한 번에 16개의 EC2 인스턴스만 같은 볼륨에 연결이 가능하다.**
- 다중 연결을 실행하면 반드시 클러스터 인식 파일 시스템을 사용해야 한다.
    - xfs, ex4와 다르다.

---

## EBS Encryption

- EBS 볼륨을 생성하면
    - 저장 데이터가 볼륨 내부에 암호화된다.
    - 인스턴스와 볼륨 간의 전송 데이터도 암호화된다.
    - 스냅샷과 스냅샷으로 생성한 볼륨 모두 암호화된다.
- 암호화 및 복호화 매커니즘은 백그라운드에서 EC2와 EBS가 보이지 않게 처리한다.
- 암호화 지연 시간에 영향이 없다.
- KMS에서 암호화 키를 생성해 AES-256 암호화 표준을 갖는다.
- 스냅샷을 복사해 암호화를  푼 것을 다시 암호화 활성화하는 것이다.

### EBS 볼륨 암/복호화

- EBS 볼륨 스냅샷을 생성하고 복사 기능을 통해 EBS 스냅샷을 암호화한다.
- 스냅샷을 이용해 새로운 볼륨을 생성하면 해당 볼륨도 암호화한다.
- 암호화된 볼륨을 인스턴스 원본에 연결한다.

---

## Amazon EFS

- Elastic File System
- 관리형 NFS, 네트워크 파일 시스템이다.
- 여러 EC2 인스턴스에 마운트될 수 있다.
- 이러한 **EC2 인스턴스들은 여러 가용 영역에 있을 수 있다.**
- 가용성이 높고 확장성도 높다.
- 가격도 비싸다. (EBS의 3배 정도..)
- 사용량만큼 지불하므로 미리 용량을 프로비저닝하지 않아도 된다.
    - 파일 시스템이 자동을 확장된다.
    - 사용한 GB당 데이터 비용을 지불한다.
- Use Case
    - 콘텐츠 관리 : 웹 서버, 데이터 공유, 워드프레스
    - NFS 프로토콜 사용
- EFS에 대한 액세스 제어를 위해 보안그룹 설정해야 한다.
- 윈도우가 아닌 리눅스 기반 AMI와 호환된다.
- KMS를 사용해서 EFS 드라이브에 저장 데이터 암호화를 활성화할 수 있다.
- POSIX 시스템을 사용하고 표준 파일 API를 가진다.

### EFS Performance & Storage Classes

**EFS Performance**

- EFS Scale
    - 수천개의 NFS 클라이언트에서 EFS에 동시 액세스할 수 있게 확장되고, 처리량을 초당 10GB이다.
    - 용량을 미리 프로비저닝하지 않아도 네트워크 파일 시스템이 PB 규모로 자동 확장된다.
- **EFS 성능 모드**
    - **범용 모드(기본)** : 지연 시간에 민감한 웹 서버, CMS와 같은 사례에 사용
    - **Max I/O** - I/O 최대화를 원하면 사용, 지연 시간, 처리량, 병렬 처리 성능이 향상된다. (빅데이터, 미디어 처리 작업에 유용)
- **EFS 처리량 모드**
    - **버스팅 모드 (기본)** : 1TB 파일 시스템의 데이터 전송 속도는 초당 약 50MiB이다. (초당 100MiB로 향상 가능), 사용 공간이 많을수록 버스팅 용량과 처리량이 늘어난다.
    - **프로비저닝 모드** : 스토리지 공간 사이즈와 상관없이 처리량을 설정할 수 있다.

**Storage Classes**

- 스토리지 계층을 설정할 수 있다.
- **일정 기간 후에 파일을 다른 계층으로 옮기는 기능**이다.
    - **standard 계층** : 액세스가 빈번한 파일
    - **EFS-IA 계층** : 파일 검색할 경우, 검색에 대한  비용 발생(저장 비용은 낮음), 수명주기 정책을 사용해야 함
    - 사용 방법 예시 ) 30일 동안 액세스하지 않는다면 EFS-IA 계층으로 이동시킨다는 수명 주기 정책을 작성한다. (비용 절감)
- 가용성과 내구성 측면
    - **Standard 옵션** : EFS를 다중 AZ에 설정한다. **(Regional)**
    - **One Zone 옵션** : EFS을 하나의 AZ에 설정, 개발할 때 좋음, 백업할 때 기본적으로 활성화됨, EFS-IA 스토리지 계층과 호환됨 (EFS One Zone-IA)

---

## EFS vs EBS

### EBS(Elastic Block Storage)

- 한 번에 하나의 인스턴스만 연결이 가능하다.
- 특정 가용영역에 한정된다.
- gp2 : 디스크 크기가 늘어나면 IO도 함께 증가한다.
- io1 : IO를 볼륨 크기와 관계없이 독립적으로 증가시킬 수 있다. (중요한 데이터베이스 실행시 좋음)
- EBS를 다른 가용영역으로 옮기는 경우, 스냅샷을 찍고, 그 스냅샷을 다른 가용영에서 복원한다.
- EBS의 스냅샷과 백업을 만들 때는, EBS 볼륨 내의 모든 IO를 전부 사용하므로 인스턴스가 EBS 볼륨을 사용하지 않을 때 실행해야 한다.
- EC2 인스턴스가 종료되면 인스턴스 내의 루트 EBS 볼륨은 기본적으로 종료된다. (원할 경우 동작을 비활성화 할 수 있다.)
- EBS는 실제 사용한만큼이 아니라 드라이브 크기에 따라 비용이 청구된다. (정해진 사용량)

### EFS(Elastic File System)

- 여러개의 가용 영역에 걸쳐 많은 인스턴스와 연결될 수 있다.
- EFS Mount Target을 사용해 특정 AZ에서 EC2 인스턴스들과 EFS 드라이브를 연결해줄 수 있다.
- Linux 인스턴스에서만 가능하다. (POSIX 파일 시스템이기 때문에, 윈도우에서 구동되지 않는다.)
- EFS > EBS (3배 정도.. 훨씬 비싸다)
- 비용을 절약하고 싶다면 스토리지 티어로 EFS-IA를 사용한다. (수명 정책 사용)
- EFS는 사용한만큼 비용이 청구된다.
- EFS는 다수의 인스턴스를 걸 네트워크 파일 시스템에 적합하다.

### EC2 Instance Store

- EC2 인스턴스에 I/O를 최대로 사용할 수 있다.
- 하지만, EC2 인스턴스가 종료되면 같이 종료되기 때문에 임시 드라이브로 적합하다.
